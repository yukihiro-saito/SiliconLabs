#+STARTUP: indent inlineimages fninline
#+OPTIONS: ^:nil
#+OPTIONS: \n:t
この本のSilicon Labsのアプリケーション開発の基礎シリーズは、Bluetooth低エネルギー技術の概要を提供します。
従来のBluetooth技術は、電力効率の良い方法で高品質のデータを安定して送信するために最適化されています。
Bluetooth LE 技術は、長距離無線接続の短時間バーストを可能にし、長いバッテリ寿命に依存し、高スループットのストリーミングデータを必要としないアプリケーションに最適です。
この概要では、Bluetooth低エネルギー技術に焦点を当てていますが、従来のBluetooth技術と対照的な点もいくつか挙げています。

Silicon Labsのアプリケーション開発の基礎シリーズは、Silicon Labsチップ、EmberZNet PROやSilicon Labs Bluetooth低エネルギーなどのネットワーキングスタック、および関連する開発を使用して、組み込みネットワーキングソリューションを開発する前に、プロジェクトマネージャ、アプリケーション設計者、開発ツール。このドキュメントは、ワイヤレスネットワークアプリケーションの開発を紹介する人や、Silicon Labs開発環境の初心者を対象としています。

* Background
Silicon Labsは、IoT（Internet of Things）と呼ばれる家庭内の常時接続されたデバイスの世界に移行する際に、顧客の要求を満たすように設計された製品を開発しています。
高いレベルでは、Silicon LabsのIoTの目標は次のとおりです。
- 家庭内のすべてのデバイスを、ZigBee PRO、スレッド、Bluetooth低エネルギーテクノロジ、その他新興標準のいずれであっても、クラス最高のネットワーキングで接続します。
- エネルギーに優しいマイクロコントローラに関する当社の専門知識を活用する。
- 確立された低電力、ミックスド・シグナル・チップを強化する。既存のイーサネットおよびWi-Fiデバイスに低コストのブリッジを提供します。
- スマートフォンやタブレットへのクラウドサービスと接続を可能にし、使いやすさと共通のユーザーエクスペリエンスを顧客に提供します。

これらの目標をすべて達成することで、Connected HomeのIoTデバイスの採用率とユーザーの受け入れが向上します。
Bluetooth技術は、IoTの中核部分です。
Bluetoothは、無線伝送を使用してデータを交換することによって、ケーブル接続の代替無線を提供するように設計されていました。
Bluetoothの最も一般的なアプリケーションの1つは、ワイヤレスオーディオです。
これは、BR/EDR（Bit Rate / Enhanced Data Rate）と呼ばれるBluetoothのバージョンを使用しています。
これは、高品質のデータを電力効率の良い方法で安定して送信するために最適化されています。
Bluetoothバージョン4.0は、低エネルギー機能を備えたBluetoothを発表しました。
開発者は、コイン型電池で数ヶ月、さらには数年も稼働できるセンサーを開発することができます。
これらのセンサの中には、スイッチを反転させることによる運動エネルギーが動作電力を提供できるほど効率的であるものがあります。
Bluetoothの低エネルギー技術は本質的にBR/EDRとは異なります。
BR/EDRは、比較的短距離の連続無線接続を確立し、スマートフォンからヘッドセットへの音声ストリーミングなどの用途に最適です。
Bluetoothの低エネルギー技術は長距離無線接続の短時間バーストを可能にし、長いバッテリ寿命に依存するIoTアプリケーションに最適です。
さらに、Bluetooth低エネルギー技術は、GATT（Generic Attributes）を使用したまったく新しい開発フレームワーク上に構築されています。
GATTプロファイルは、GATT機能に基づくユースケース、ロール、および一般的な動作を記述します。
これらのプロファイルにより、開発者はスマートフォン、PC、タブレット上で動作するアプリケーションにデバイスを直接接続するためのアプリケーションを素早く簡単に開発できます。
Bluetoothデバイスは、BR/EDRとBluetooth低エネルギーテクノロジの両方をサポートするデュアルモード、またはBluetooth低エネルギーテクノロジのみをサポートするシングルモードのいずれかになります。

スマートフォン、PC、タブレットなどの超低消費電力と接続性だけでなく、Bluetooth低エネルギー技術の他のメリットは次のとおりです。
- 低価格
- 信頼性と堅牢性:AFH（Adaptive Frequency Hopping）、再送信、24ビットCRC（巡回冗長検査）
- セキュア:ペアリング、ボンディング、プライバシー、MITM（Man in the Middle）保護、AES-128暗号化
- 迅速な開発をサポート:•主要な使用事例（HR、HID、グルコース、近接性など）をカバーする標準化されたプロファイル
- プロファイルはアプリケーションとして開発でき、迅速な展開をサポートします
- ベンダー固有のプロファイルでは、Bluetooth SIGがプロファイルとオペレーティングシステム開発者を統一するのを待つ必要がなくなります
- 幅広く導入可能:iOS、Android 4.3以降、Windows 8,10、OSX、Linuxの主要なプラットフォームでサポートされています。Bluetooth仕様はBluetooth SIG（Special Interest Group）によって管理されています。SIGは、入門情報と仕様へのリンクとその他の技術的詳細の両方を含むウェブサイト（https://www.bluetooth.com） を管理しています。このドキュメントでは、仕様の改訂は括弧で括られています。ここで、（BT5.0）は仕様のバージョン5.0を意味します。

このドキュメントでは、Bluetooth低エネルギーの次の側面の概要を説明します。
- Bluetoothアーキテクチャの概要
- ラジオ機能
- リンクレイヤの基本
- デバイスの検出と接続の仕組みの説明
- Bluetoothセキュリティの概要
- 属性プロトコル
- 汎用属性プロファイル（GATT）とBluetoothプロファイル

* Bluetooth Low Energy Architecture
Bluetooth LE アーキテクチャを次の図に示します。
[[file:Bluetooth LE Architecture.png][Bluetooth LE Architecture]]

コンポーネントは次のとおりです。
- 物理層:無線の送受信を制御します。
- リンクレイヤ: パケット構造を定義し、ステートマシンと無線コントロールを含み、リンクレイヤレベルの暗号化を提供します。

これらの2つのレイヤーはコントローラにグループ化され、残りのレイヤーはホストにグループ化されます。
ホスト-コントローラインタフェース（HCI）は、コントローラとホスト間の通信を標準化します。
ホスト層は次のとおりです。
- L2CAP:論理リンク制御と適応プロトコル。 L2CAPはプロトコルマルチプレクサとして機能し、パケットのセグメント化と再アセンブリを処理します。また、1つまたは複数の論理リンクを介して多重化された論理チャネルを提供します。Bluetooth LE 技術で使用されるL2CAPは、従来のBluetooth L2CAPに基づいて最適化され、簡素化されたプロトコルです。通常、アプリケーション開発者はL2CAPレイヤーとのやりとりの詳細を気にする必要はありません。相互作用はBluetoothスタックによって処理され、L2CAP操作の詳細はこのドキュメントでは扱いません。
- ATT: 属性プロトコル。属性プロトコルは、Bluetooth LE デバイス間でデータを送信する手段を提供する。それは、Bluetooth LE 接続に依存し、その接続を介して属性値を読み書きし、指示し、通知する手順を提供する。ATTは、ほとんどのBluetooth LE アプリケーションで、時にはBR/EDRアプリケーションで使用されます。
- GATT:汎用属性プロファイル。 GATTは、個々の属性を論理サービス（例えば、心拍センサの動作を公開する心拍サービス）にグループ化するために使用されます。実際のデータに加えて、GATTは、属性、すなわちアクセス方法と必要なセキュリティレベルに関する情報も提供します
- GAP:汎用アクセスプロファイル。GAPレイヤは、Bluetooth LE デバイスが自分自身または他のデバイスをAdvertiseし、デバイス発見を行い、接続を開いて管理し、データをブロードキャストする手段を提供します。
- SM:セキュリティマネージャ。デバイスの結合、データの暗号化と復号化、デバイスのプライバシーを有効にする手段を提供します。

これらのコンポーネントについては、以降のセクションで詳しく説明します。

* Physical Layer
Bluetooth LE は2.4GHz ISM（産業科学医療）帯域（2402 MHz〜2480 MHz）で動作します。
これはほとんどの国でライセンスフリーです。Bluetooth 4仕様では、40 MHzのRFチャネルと2 MHzのチャネル間隔が定義されています（次の図を参照）。
40チャネルのうち3つは、デバイスの検出、接続の確立、およびブロードキャストに使用されるAdvertising Channel（緑色で表示）です。Advertise Channelの周波数は、いくつかの国で一般的に使用されているIEEE 802.11チャネル1,6,11からの干渉を最小限に抑えるように選択されています。
Bluetooth 5仕様では、以下で強調表示されている3つのAdvertiseチャネルを1次Advertiseチャネルと呼びます。37個の残りのチャネルは、追加のAdvertiseデータ送信に使用できる二次Advertiseチャネルまたはデータチャネルとして使用される。

[[file:Bluetoot Low Energy Channels and Frequencies.png][Bluetooth Low Energy Channels Frequencies]]

データチャネルは、接続されたデバイス間の双方向通信に使用されます。
AFH（Adaptive FHSS）は、所定の時間間隔の間、通信のためのデータチャネルを選択するために使用される。
AFHは信頼性が高く、堅牢で、干渉に適応します。
すべての物理チャネルは、変調指数が0.5であるGFSK（Gaussian Frequency Shift Keying）変調を使用し、ピーク電力消費を低減します。
Bluetooth 4.0, 4.1, 4.2仕様では、物理層のデータレートは1Mbpsです。
Bluetooth 5標準では、スループットを向上させたり、TXとRXの時間を短縮するために、2M PHYレートを追加しています。
Bluetooth規格および規制規格の最近の変更により、Bluetooth Smartデバイスは最大100mW（20dBm）の送信電力を送信できます。
しかし、干渉が大きい場合、Bluetooth低エネルギー無線が2つのRFチャネルに降下する可能性があるので、すべての国が100mWの送信電力を使用できるわけではありません。
Bluetooth低エネルギー無線の要件は次のとおりです。

| Feature                | Value              |
|------------------------+--------------------|
| /                      | <>                 |
|------------------------+--------------------|
| Minimum TX power       | 0.01 mW (-20 dBm)  |
|------------------------+--------------------|
| Maximum TX power       | 100 mW (20 dBm)    |
|------------------------+--------------------|
| Minimum RX sensitivity | -70 dBm (BER 0.1%) |

Bluetooth低エネルギー無線の一般的な距離範囲は次のとおりです。

| TX power | RX sensitivity | Antenna gain | Range      |
|----------+----------------+--------------+------------|
| /        | <>             | <>           | <>         |
|----------+----------------+--------------+------------|
| 0 dBm    | -92 dBm        | -5 dB        | 160 meters |
|----------+----------------+--------------+------------|
| 10 dBm   | -92 dBm        | -5 dB        | 295 meters |

スマートフォンの範囲は、電話機のRF性能が限られているため、通常0〜50メートルです。

* Link Layer
Bluetooth LE リンク層は、生の無線操作とビットストリームの送受信を介した第1レベルの制御およびデータ構造を提供します。例えば、リンク層は以下を定義する。
- Bluetoothステートマシンと状態遷移
- データとAdvertiseのパケットフォーマット
- リンクレイヤー操作
- 接続、パケットタイミング、再送信
- リンクレイヤレベルのセキュリティ

アプリケーション開発者はこれらを詳細に理解する必要はありませんが、アプリケーションの設計、開発、およびエンドデバイスの動作にはいくつかの重要な概念が影響します。
これらの概念の概要は、このセクションで提供されています。

** Link Layer Operations
このセクションでは、以下を含むBluetooth LE リンク層の基本操作について説明します。
- Advertising
- Scanning
- 接続の確立

*** Advertisement
Advertisementは、Bluetooth LE 無線技術における最も基本的な操作の1つです。
Advertisementは、デバイスが存在をブロードキャストし、接続を確立させ、オプションとして、サポートされているサービスのリスト、またはデバイス名とTX電力レベルのようなデータをブロードキャストする手段を提供します。
Advertiseを行っているBluetooth LE デバイスは、1つまたは複数のAdvertiseチャネルでパケットをブロードキャストします。

[[file:Bluetooth Low Energy Advertisement.png][Bluetooth Low Energy Advertisement]]

アプリケーションは、通常、以下のAdvertisementパラメータの制御を有します。
| Parameter              | Values                                                                     | Description                                                                                                                                                                                                                                            |
|------------------------+----------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| /                      | <>                                                                         | <>                                                                                                                                                                                                                                                     |
|------------------------+----------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Advertisement interval | 20 ms to 10240 ms                                                          | Defines the interval between the advertisement events. Each event consist of 1 to 3 advertisement packets depending on the configuration. A random 0-10 ms is added by the link layer to every advertisement interval to help avoid packet collisions. |
|------------------------+----------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Advertisement channels | 37, 38 and 39 (primary channels) 0-10 and 11-36 (BT 5 secondary channels)  | The physical RF channels used to transmit the advertisement packets. For most reliable operation all channels should be used, but reducing the number of channels used will reduce power consumption at the cost of reliability.                       |
|------------------------+----------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Discoverability mode   | Not discoverable Generic Discoverable  Limited Discoverable Broadcast      | Defines how the advertiser is visible to other devices.                                                                                                                                                                                                |
|------------------------+----------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Connectability mode    | Not connectable Directed Connectable Undirected connectable                | Defines if the advertiser can be connected or not                                                                                                                                                                                                      |
|------------------------+----------------------------------------------------------------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Payload                | 0 to 31 B (primary advertisement) 0 to 255 B (BT5 secondary advertisement) | 0-31 bytes of data can be included in each primary advertisement packet. 0-255 bytes of data can be included in each secondary advertisement packet (Bluetooth 5)                                                                                      |

*** Scanning
スキャンとは、スキャナが、Advertiseデバイスによってブロードキャストされたデータを発見し、発見と接続し、または単に受信するために、到来するAdvertiseをListenする動作である。
パッシブスキャン（6ページの図4.2パッシブスキャン）とアクティブスキャン（8ページの図4.3アクティブスキャン）の2種類のスキャンモードがサポートされています。
パッシブスキャンモードでは、スキャナは着信Advertiseパケットを単にListenします。
スキャナは、一度に1つのチャンネルを聞いてラウンドロビン方式で各Advertiseチャネルを循環します。

[[file:Passive Scanning.png][Passive Scanning]]

アクティブスキャンモードでは、スキャナは着信アドバタイズパケットをListenし、受信したアドバタイズパケットを受信すると、それについての詳細を知るために追加のスキャン要求パケットを広告主に送信します。
通常、スキャン応答には、サポートされているサービスやわかりやすい名前のリストなどの情報が含まれていますが、アプリケーションはスキャン応答データのペイロードを完全に制御しています。

[[file:Active Scanning.png][Active Scanning]]

アプリケーションは、通常、次のスキャンパラメータを制御します。

| Parameter           | Values                | Description                                                                                                                                 |
|---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------|
| /                   | <>                    | <>                                                                                                                                          |
|---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------|
| Scan interval       | 2.5 ms to 10240 ms    | The interval is ms from the beginning of a scan event to a beginning of a consecutive scan event. Must be equal or larger than scan window. |
|---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------|
| Scan window         | 2.5 ms to 10240 ms    | The scan window defines the duration of the listening (RX) window during a scan event.                                                      |
|---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------|
| Scan type           | Limited               | Defines which type of advertisers the scanner reports.                                                                                      |
|                     | Generic               |                                                                                                                                             |
|                     | Observation           |                                                                                                                                             |
|---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------|
| Scan mode           | Active                | Defines if active or passive scanning is performed.                                                                                         |
|                     | Passive               |                                                                                                                                             |
|---------------------+-----------------------+---------------------------------------------------------------------------------------------------------------------------------------------|
| Connectability mode | Not connectable       | Defines if the advertiser can be connected to or not                                                                                        |
|                     | Directed Connectable  |                                                                                                                                             |
|                     | Undirected Connectabe |                                                                                                                                             |

*** Connections
Bluetooth LE 接続では、正しいデータ配信を保証するために、紛失したデータのCRC、肯定応答、および再送信を使用することで、
Connectionsによりアプリケーションデータを信頼性が高く堅牢な方法で送信できます。
さらに、Bluetooth LE 接続は、周囲のRF条件を検出し適応させ、信頼性の高い物理層を提供するために、適応周波数ホッピング（AFH）を使用します。
Connectionsはまた、データの暗号化と復号化をサポートして機密性を保証します。
Bluetooth LE 接続は、常に、Advertise主が接続を許可するという事実を含むAdvertisementパケットを受信するスキャナによって開始される。
次の図は、Bluetooth LE 接続の確立方法を示しています。

[[file:Connections.png][Connections]]

アプリケーションは、通常、次の接続パラメータを制御します。

| Parameter                  | Values                          | Description                                            |
|----------------------------+---------------------------------+--------------------------------------------------------|
| /                          | <>                              | <>                                                     |
|----------------------------+---------------------------------+--------------------------------------------------------|
| hMinimum Connection        | Interval 7.5 ms                 | Minimum allowed connection interval                    |
|----------------------------+---------------------------------+--------------------------------------------------------|
| Maximum Connection         | Interval 4000 ms                | Maximum allowed connection interval                    |
|----------------------------+---------------------------------+--------------------------------------------------------|
| Connection (slave) latency | 0 to 500 (connection intervals) | The amount of connection events the slave is allowed   |
|                            |                                 | to skip if it has no data to send.                     |
|----------------------------+---------------------------------+--------------------------------------------------------|
| Supervision timeout        | 100 ms to 32000 ms              | Defines how long the break in communications can be    |
|                            |                                 | (for example due to out of range situation) before the |
|                            |                                 | connection is dropped and an error is presented to the |
|                            |                                 | user.                                                  |

接続パラメータは、接続更新メッセージを使用して接続のライフタイム中に更新することができる。

マスターが定義された接続間隔でスレーブにパケットを送信すると、接続イベント（Connection Timelineの図）が開始されます。
スレーブは、マスターからのパケットを受信した後、150μsに応答することができます。
スレーブが送信するデータがない場合は、スレーブ待ち時間パラメータで定義された一定数の接続イベントをスキップできます（Connection Timelineの図）。
スーパーバイザタイムアウトによって定義された時間内にパケットがマスタまたはスレーブによって受信されない場合、接続は終了する。

[[file:Connection Timeline.png][Connection Timeline]]

[[file:Slave Latency(Latency 3).png][Slave Latency]]

スレーブが送信するデータの量が単一パケットに収まらない場合、接続イベントは自動的に延長され、
スレーブは次の接続間隔の開始までの時間があるときにパケットを送信することができます。
これは、肯定応答を必要としない属性プロトコル操作でのみ使用できます。


